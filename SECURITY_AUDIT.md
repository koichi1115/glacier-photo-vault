# Security Analysis Report: Glacier Photo Vault

## 1. 概要
本レポートは、`glacier-photo-vault` アプリケーションのソースコード分析に基づくセキュリティ評価結果です。
特に、ユーザーが懸念している「写真の漏洩」、「不正アクセス」、「なりすまし」のリスクに焦点を当て、IPA（独立行政法人情報処理推進機構）のセキュリティガイドラインおよび一般的なセキュリティベストプラクティス（OWASP Top 10等）と照らし合わせて評価を行いました。

## 2. 総合評価
*   **バックエンド (API)**: 認証・認可の仕組みは堅牢に設計されていますが、可用性（DoS攻撃への耐性）とデータの整合性に課題があります。
*   **フロントエンド**: 認証トークンの送信処理が実装されておらず、現状のままではバックエンドと通信できないか、セキュリティ機能を無効化しないと動作しない状態です。
*   **インフラ (AWS S3)**: 基本的な設計はセキュアですが、メタデータの管理方法に脆弱性があります。

## 3. 詳細分析

### 3.1. 写真の漏洩リスク (Confidentiality)
**評価: 中 (運用次第で高)**

*   **現状の対策**:
    *   **S3バケット**: コード上では `getSignedUrl` を使用しており、バケット自体は非公開（Private）設定であることを前提とした実装になっています。これは適切な設計です。
    *   **暗号化**: アップロード時に `ServerSideEncryption: 'AES256'` を明示的に指定しており、保管時の暗号化がなされています。
    *   **ダウンロード**: 署名付きURL（有効期限1時間）を使用しており、永続的な公開URLは発行されません。

*   **懸念事項**:
    *   **メタデータの管理**: 写真のメタデータ（タイトル、説明、タグ）が `userId/metadata.json` という単一のJSONファイルに保存されています。
        *   **リスク**: 万が一S3のバケットポリシー設定ミスでバケットが公開された場合、ファイル名が推測可能（`userId`さえわかればアクセス可能）であるため、ユーザーの全写真リストやメタデータが容易に漏洩します。
    *   **ディレクトリトラバーサル**: アップロード時の `relativePath` パラメータがそのままS3キーの一部として使用されています。S3はフラットな構造なのでOSレベルのトラバーサル（`/etc/passwd`へのアクセス等）は起きませんが、意図しないキー名での保存が可能です。

### 3.2. 不正アクセスおよびなりすましリスク (Authentication & Authorization)
**評価: 低 (バックエンド)、高 (フロントエンド)**

*   **バックエンド (Backend)**:
    *   **認証方式**: JWT (JSON Web Token) と RSA公開鍵暗号（RS256）を使用しており、非常に堅牢です。
    *   **認可制御**: `authorizeOwner` および `authorizePhotoOwner` ミドルウェアにより、リソースへのアクセス時に厳密に所有者チェックが行われています。他人の `userId` を指定しても、トークン内のIDと一致しなければ拒否されます。
    *   **トークン管理**: アクセストークン（1時間）とリフレッシュトークン（7日）の分離、およびリフレッシュトークンのローテーション機能が実装されています。

*   **フロントエンド (Frontend)**:
    *   **実装不備**: 現状の `PhotoVault.tsx` などのコードには、APIリクエスト時に `Authorization` ヘッダー（JWT）を付与する処理が含まれていません。
    *   **リスク**: このままでは認証エラーで動作しません。もし「動かすため」にバックエンドの認証を無効化した場合、誰でも他人の `userId` を指定して写真にアクセスできる状態になります。

### 3.3. 可用性とデータの整合性 (Availability & Integrity)
**評価: 高リスク (Critical)**

*   **インメモリ依存 (DoSリスク)**:
    *   **ファイルアップロード**: `multer.memoryStorage()` を使用しており、アップロードされたファイル（最大100MB）がサーバーのメモリ上に展開されます。複数のユーザーが同時にアップロードすると、サーバーがメモリ不足（OOM）でクラッシュする可能性があります。
    *   **セッション管理**: リフレッシュトークンや写真のキャッシュが `Map` オブジェクト（メモリ内）に保存されています。
        *   **リスク**: サーバーが再起動すると、全ユーザーが強制ログアウトされ、キャッシュも消えます。また、サーバーを複数台構成（スケーリング）することができません。

*   **競合状態 (Race Condition)**:
    *   **メタデータ更新**: `metadata.json` を「読み込み -> メモリで更新 -> 保存」という手順で処理しています。同時に2つのリクエスト（例：アップロードとタグ編集）が走ると、片方の変更が上書きされて消える可能性があります。

## 4. 改善提案 (Action Plan)

### 優先度: 高 (直ちに対応すべき事項)
1.  **フロントエンドの認証実装**:
    *   ログイン画面の実装と、APIリクエストへの `Authorization: Bearer <token>` ヘッダーの付与。
2.  **インメモリ処理の廃止**:
    *   **アップロード**: `multer-s3` 等を使用し、サーバーメモリを経由せずS3へ直接ストリーム転送するよう変更する。
    *   **トークンストア**: リフレッシュトークンの保存先をRedisまたはデータベース（PostgreSQL等）に変更する。
3.  **メタデータ管理の見直し**:
    *   JSONファイルではなく、DynamoDBやRDS（PostgreSQL）などのデータベースでメタデータを管理する。これにより競合状態と漏洩リスクを解決できます。

### 優先度: 中 (セキュリティ向上のための事項)
1.  **入力値の検証強化**:
    *   `relativePath` などのパラメータに対して、厳格なバリデーション（正規表現チェック等）を追加する。
2.  **ウイルススキャン**:
    *   アップロードされたファイルに対して、ClamAV等によるウイルススキャンを導入する（AWS Lambda等で非同期に実行）。

## 5. 参照ガイドライン
*   **IPA 安全なウェブサイトの作り方**:
    *   「アクセス制御の不備」への対策（バックエンドは適合）
    *   「セッション管理の不備」への対策（インメモリ管理は不適合）
*   **OWASP Top 10 (2021)**:
    *   A01:2021-Broken Access Control (アクセス制御の不備)
    *   A04:2021-Insecure Design (安全でない設計 - メモリ依存など)
